parameters:
  - name: 'FolderName'
    type: string
    default: "./targetproject2"

  - name: 'ConnectionString'
    type: string
    default: "Data Source=127.0.0.1,5001;Initial Catalog=test;User ID=sa;Password=Strong_password_123!;Integrated Security=false;Trust Server Certificate=true"
  
  - name: 'TimeoutInMinutes'
    type: number
    default: 20
  
  - name: 'ArtifactFeedName'
    type: string
    default: 'DefaultFeed'

  - name: 'FeedPackageName'
    type: string
    default: 'dbupgrade'
    
jobs:
- job:
  timeoutInMinutes: '${{ parameters.TimeoutInMinutes }}'
  cancelTimeoutInMinutes: 2
  pool: MyPool
  steps:
    - checkout: self
      fetchDepth: 0

    - task: UniversalPackages@0
      displayName: Download a Universal Package
      inputs:
        command: download
        vstsFeed: 'dbupgrade-poc/${{ parameters.ArtifactFeedName }}'
        vstsFeedPackage: '${{ parameters.FeedPackageName }}'
        vstsPackageVersion: '*'
        downloadDirectory: '$(Build.SourcesDirectory)'

    - task: ExtractFiles@1
      inputs:
        archiveFilePatterns: '$(Build.SourcesDirectory)/$(Build.BuildId).zip'
        cleanDestinationFolder: false
        overwriteExistingFiles: true

    - task: CmdLine@2
      inputs:
        script: 'DbUp-POC.exe clean -c "${{ parameters.ConnectionString }}" -f "${{ parameters.FolderName }}"'
        workingDirectory: '$(Build.SourcesDirectory)/net8.0'
        failOnStderr: true