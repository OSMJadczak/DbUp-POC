parameters:
  - name: 'FolderName'
    type: string
    default: "./targetproject2"

  - name: 'TimeoutInMinutes'
    type: number
    default: 20
  
  - name: 'ArtifactFeedName'
    type: string
    default: 'DefaultFeed'

  - name: 'FeedPackageName'
    type: string
    default: 'dbupgrade'

  - name: 'DisplayName'
    type: string
    default: 'Database upgrade'

  - name: 'VariableGroupName'
    type: string

jobs:
- job: '${{ parameters.DisplayName }}'
  timeoutInMinutes: '${{ parameters.TimeoutInMinutes }}'
  cancelTimeoutInMinutes: 2
  variables:
    - group: '${{ parameters.VariableGroupName }}'
  pool: '$(PoolName)'
  steps:
    - checkout: self
      fetchDepth: 0

    - task: UniversalPackages@0
      displayName: Download a Universal Package
      inputs:
        command: download
        vstsFeed: 'dbupgrade-poc/${{ parameters.ArtifactFeedName }}'
        vstsFeedPackage: '${{ parameters.FeedPackageName }}'
        vstsPackageVersion: '*'
        downloadDirectory: '$(Build.SourcesDirectory)'

    - task: ExtractFiles@1
      inputs:
        archiveFilePatterns: '$(Build.SourcesDirectory)/$(Build.BuildId).zip'
        cleanDestinationFolder: false
        overwriteExistingFiles: true

    - task: CmdLine@2
      inputs:
        script: 'DbUp-POC.exe clean -c "$(ConnectionString)" -f "${{ parameters.FolderName }}"'
        workingDirectory: '$(Build.SourcesDirectory)/net8.0'
        failOnStderr: true